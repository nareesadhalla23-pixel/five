<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‚ù§Ô∏è Five Years, Five Games</title>
  <meta name="description" content="A tiny bundle of love games: Connections, Wordle, and a mini Crossword." />
  <style>
    :root{
      --bg: #0f1222; /* deep indigo */
      --card: #161a2f;
      --accent: #ff5fa2; /* pink */
      --accent-2: #7c5cff; /* purple */
      --text: #f5f7ff;
      --muted: #c9cdfa99;
      --good: #61d095;
      --warn: #ffd166;
      --bad: #ef476f;
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 800px at 10% -10%, rgba(255,95,162,.15), transparent),
                       radial-gradient(900px 600px at 100% 10%, rgba(124,92,255,.18), transparent),
                       var(--bg);
         color:var(--text); font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;}
    header{padding:28px 18px 8px; text-align:center}
    h1{margin:0; font-size: clamp(24px, 4vw, 40px); letter-spacing:.5px}
    .sub{color:var(--muted); margin-top:6px}

    .shell{max-width:980px; margin:18px auto 80px; padding:0 14px}
    .tabs{display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin:18px 0}
    .tab{border:1px solid #ffffff22; color:var(--text); padding:10px 14px; border-radius:999px; cursor:pointer; background:#ffffff08; backdrop-filter:saturate(120%) blur(6px); display:flex; align-items:center; gap:8px}
    .tab.active{border-color:transparent; background:linear-gradient(135deg,var(--accent),var(--accent-2)); box-shadow:0 10px 24px #00000040}
    .tab.locked{opacity:.5; cursor:not-allowed}
    .view{display:none}
    .view.active{display:block}

    .card{background:var(--card); border:1px solid #ffffff14; border-radius:16px; padding:16px; box-shadow:0 8px 30px #0000003a}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .note{ color:var(--muted); font-size:14px }

    /* Connections */
    .grid16{ display:grid; grid-template-columns:repeat(4, minmax(120px,1fr)); gap:10px; }
    .tile{ user-select:none; text-transform:uppercase; padding:14px 10px; border-radius:14px; background:#1d2141; border:1px solid #ffffff1f; text-align:center; font-weight:700; letter-spacing:.6px; cursor:pointer; min-height:56px; display:flex; align-items:center; justify-content:center }
    .tile.selected{ outline:2px solid var(--accent); box-shadow:0 0 0 2px #ffffff10 inset }
    .groups{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; margin-top:16px}
    .group{ background:#11142a; border:1px dashed #ffffff2a; border-radius:14px; padding:12px }
    .badge{ display:inline-block; background:linear-gradient(135deg,var(--accent),var(--accent-2)); padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700 }
    .controls{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    button{ background:#ffffff12; color:var(--text); border:1px solid #ffffff26; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:700 }
    button.primary{ background:linear-gradient(135deg,var(--accent),var(--accent-2)); border:none }
    .lives{ margin-left:auto; color:var(--muted) }
    .toast{ margin-top:10px; color:var(--muted) }
    .success{ color:var(--good); font-weight:700 }
    .fail{ color:var(--bad); font-weight:700 }

    /* Wordle */
    .wordle-board{ display:grid; grid-template-rows: repeat(6, 1fr); gap:8px; width:min(360px, 92%); margin:12px auto }
    .row5{ display:grid; grid-template-columns: repeat(5, 1fr); gap:8px }
    .cell{ aspect-ratio:1/1; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:22px; text-transform:uppercase; border-radius:10px; background:#1d2141; border:2px solid #2a2f57 }
    .cell.filled{border-color:#444a84}
    .cell.correct{ background:var(--good); color:#0a1b14; border-color:transparent }
    .cell.present{ background:var(--warn); color:#332808; border-color:transparent }
    .cell.miss{ background:#2f335c; color:#8b90c9; border-color:#2f335c }
    .kb{ display:grid; grid-template-columns: repeat(20, 1fr); gap:6px; max-width:760px; margin:14px auto }
    .key{ grid-column: span 2; padding:10px 0; border-radius:10px; background:#1d2141; border:1px solid #2a2f57; font-weight:700; text-transform:uppercase }
    .key.wide{ grid-column: span 3 }
    .key.dead{ opacity:.45 }

    /* Crossword */
    .xw-wrap{ display:inline-grid; grid-template-columns: repeat(6, 42px); gap:4px; }
    .xw-cell{ width:42px; height:42px; border-radius:8px; border:2px solid #2a2f57; background:#1d2141; color:var(--text); text-align:center; font-weight:800; text-transform:uppercase }
    .xw-cell.block{ background:#0c0f22; border-color:#0c0f22 }
    .xw-clues{ margin-top:12px; display:grid; grid-template-columns:repeat(auto-fit, minmax(240px,1fr)); gap:12px }

    /* Footer */
    footer{ text-align:center; color:var(--muted); padding:40px 16px }
    .heart{ display:inline-block; transform:translateY(2px) }

    /* Gate / Modal */
    .overlay{ position:fixed; inset:0; background:rgba(10,12,26,.75); display:flex; align-items:center; justify-content:center; z-index:50 }
    .sheet{ background:var(--card); border:1px solid #ffffff1e; border-radius:16px; padding:18px; width:min(520px, 92%); box-shadow:0 20px 60px #0000007a }
    .hidden{ display:none !important }
    .shake{ animation:shake .4s }
    @keyframes shake{ 0%{transform:translateX(0)}25%{transform:translateX(-6px)}50%{transform:translateX(6px)}75%{transform:translateX(-4px)}100%{transform:translateX(0)} }
  </style>
</head>
<body>
  <!-- PASSWORD GATE -->
  <div id="gate" class="overlay">
    <div class="sheet" id="gate-sheet">
      <h2 style="margin:0 0 8px">Password to Enter üíò</h2>
      <div class="note" style="margin-bottom:10px">Finish the sentence: <em>‚ÄúSoon to be my wife, but currently my _____.‚Äù</em></div>
      <div class="row">
        <input id="pw" placeholder="type it here" style="flex:1; padding:12px; border-radius:12px; border:1px solid #ffffff24; background:#0f1230; color:var(--text); font-weight:700; text-transform:lowercase" />
        <button id="pw-btn" class="primary">Let me in</button>
      </div>
      <div id="pw-msg" class="note" style="margin-top:8px"></div>
    </div>
  </div>

  <header>
    <h1>Five Years, Infinite ‚ù§Ô∏è</h1>
    <div class="sub">A tiny page of puzzles made just for you.</div>
  </header>

  <main class="shell" id="app" aria-hidden="true">
    <div class="tabs">
      <div class="tab active" data-view="connections"><span>Connections</span></div>
      <div class="tab locked" data-view="wordle">üîí <span>Wordle</span></div>
      <div class="tab locked" data-view="crossword">üîí <span>Crossword</span></div>
    </div>

    <!-- Connections View -->
    <section id="connections" class="view active">
      <div class="card">
        <h2 style="margin:6px 0 10px">Connections</h2>
        <div class="note">Select 4 that share a theme, then press Guess. You have 4 lives. Categories are personal to us üíï</div>

        <div class="controls row">
          <button id="shuffle">Shuffle</button>
          <button id="guess" class="primary">Guess</button>
          <button id="deselect">Deselect</button>
          <div class="lives" id="lives">Lives: 4</div>
        </div>

        <div class="grid16" id="grid"></div>
        <div class="toast" id="toast"></div>

        <div class="groups" id="groups"></div>
      </div>
      <div class="note" style="margin-top:10px">Customize later by editing the <code>PUZZLE</code> object in this file.</div>
    </section>

    <!-- Wordle View -->
    <section id="wordle" class="view">
      <div class="card">
        <h2 style="margin:6px 0 10px">Wordle</h2>
        <div class="note">Five tries to guess the 5‚Äëletter word. I picked something‚Ä¶ us. üòâ</div>
        <div class="wordle-board" id="board"></div>
        <div class="kb" id="keyboard"></div>
        <div id="wordle-msg" class="note" style="text-align:center; margin-top:10px"></div>
        <div class="note" style="text-align:center; margin-top:6px">Change the answer via <code>WORDLE_ANSWER</code> below.</div>
      </div>
    </section>

    <!-- Crossword View -->
    <section id="crossword" class="view">
      <div class="card">
        <h2 style="margin:6px 0 10px">Mini Crossword ‚Äî Intense Mode ‚ö°Ô∏è</h2>
        <div class="note">Across & Down with our words. New: timer, mistakes, reveal‚Äëletter (limited), keyboard navigation, and clue highlighting. Fill every square before time runs out!</div>
        <div class="row" style="margin-top:10px; align-items:center">
          <div class="note">‚è±Ô∏è Time: <span id="xw-timer">05:00</span></div>
          <div class="note" style="margin-left:12px">‚ùå Mistakes: <span id="xw-mistakes">0</span></div>
          <div style="margin-left:auto; display:flex; gap:8px">
            <button id="xw-check">Check</button>
            <button id="xw-reveal" class="primary">Reveal Letter (3)</button>
            <button id="xw-reset">Reset</button>
          </div>
        </div>
        <div id="xw-root" style="margin-top:12px"></div>
      </div>
    </section>
  </main>

  <footer>
    Made with love <span class="heart">üíó</span> ‚Äî customize anything right in this file.
  </footer>

  <!-- FINAL MODAL -->
  <div id="final-modal" class="overlay hidden">
    <div class="sheet">
      <h2 style="margin:0 0 8px">All games complete! üéâ</h2>
      <div id="final-text" class="note" style="font-size:16px">(Your cute message will go here ‚Äî I left a placeholder variable called <code>FINAL_MESSAGE</code> in the code for you to edit.)</div>
      <div class="row" style="margin-top:12px; justify-content:flex-end">
        <button id="final-close" class="primary">üíñ Awww</button>
      </div>
    </div>
  </div>

  <script>
    /*******************
     *   CONFIG VARS   *
     *******************/
    const PASSWORD = 'GIRLFRIEND'; // case-insensitive
    const FINAL_MESSAGE = 'Happy 5 years, my favorite human. You make everything better. üíó';

    /*******************
     *  PROGRESSION    *
     *******************/
    const progress = { connections:false, wordle:false, crossword:false };
    function unlockTab(view){
      const tab = document.querySelector(`.tab[data-view="${view}"]`);
      if(tab){ tab.classList.remove('locked'); tab.innerHTML = `<span>${tab.dataset.view[0].toUpperCase()+tab.dataset.view.slice(1)}</span>`; flashToast(`${view} unlocked!`); }
    }
    function flashToast(t){ const el=document.getElementById('global-toast')||document.createElement('div'); el.id='global-toast'; el.textContent=t; el.style.position='fixed'; el.style.bottom='18px'; el.style.left='50%'; el.style.transform='translateX(-50%)'; el.style.background='linear-gradient(135deg,var(--accent),var(--accent-2))'; el.style.padding='10px 14px'; el.style.borderRadius='999px'; el.style.fontWeight='800'; el.style.zIndex='60'; document.body.appendChild(el); setTimeout(()=>el.remove(),1400); }

    /*******************
     *  PASSWORD GATE  *
     *******************/
    const gate = document.getElementById('gate');
    const pwInput = document.getElementById('pw');
    const pwBtn = document.getElementById('pw-btn');
    const pwMsg = document.getElementById('pw-msg');
    const app = document.getElementById('app');
    pwBtn.addEventListener('click', checkPw);
    pwInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') checkPw(); });
    function checkPw(){
      const v = (pwInput.value||'').trim().toUpperCase();
      if(v===PASSWORD.toUpperCase()){
        gate.classList.add('hidden');
        app.removeAttribute('aria-hidden');
        flashToast('Welcome in ‚ù§Ô∏è');
      } else {
        pwMsg.textContent = 'Close, but not quite. Try again!';
        const sheet = document.getElementById('gate-sheet');
        sheet.classList.remove('shake'); sheet.offsetWidth; sheet.classList.add('shake');
      }
    }

    /*******************
     *   CONNECTIONS   *
     *******************/
    const PUZZLE = {
      categories: [
        { name: "PLACES WE'VE BEEN", items: ["BRITISH COLUMBIA", "NEW YORK", "PUERTO RICO", "NEW JERSEY"] },
        { name: "SHARED HOBBIES", items: ["CALL OF DUTY", "STARDEW VALLEY", "MOVIES", "CAR KARAOKE"] },
        { name: "DATES", items: ["KILLER HILL", "PICNIC", "BROADWAY", "SANDBANKS"] },
        { name: "MY NICKNAMES FOR YOU", items: ["BUBBA", "MUNCHKIN", "PRINCESS PEACH", "MON PETIT CHOUCHOU"] },
      ]
    };

    const flatTiles = PUZZLE.categories.flatMap(g => g.items.map(txt => ({ txt, group: g.name })));
    let state = { tiles: shuffle([...flatTiles]), selected: new Set(), solvedGroups: [], lives: 4 };
    const grid = document.getElementById('grid');
    const toast = document.getElementById('toast');
    const groupsEl = document.getElementById('groups');
    const livesEl = document.getElementById('lives');

    function renderGrid(){
      grid.innerHTML = '';
      state.tiles.forEach((t, i) => {
        const el = document.createElement('div');
        el.className = 'tile'+(state.selected.has(i)?' selected':'');
        el.textContent = t.txt;
        el.onclick = () => toggleSelect(i);
        grid.appendChild(el);
      });
    }
    function toggleSelect(i){
      if(state.selected.has(i)) state.selected.delete(i); else if(state.selected.size < 4) state.selected.add(i);
      renderGrid();
    }
    function guess(){
      if(state.selected.size !== 4){ flashConn("Pick exactly 4 ‚ú®"); return; }
      const chosen = [...state.selected].map(i => state.tiles[i]);
      const groups = groupBy(chosen, c => c.group);
      const isSet = Object.keys(groups).length === 1;
      if(isSet){
        const groupName = chosen[0].group;
        state.solvedGroups.push(groupName);
        state.tiles = state.tiles.filter((_, idx) => !state.selected.has(idx));
        state.selected.clear();
        addSolvedGroup(groupName, chosen.map(c=>c.txt));
        flashConn('Nice! You found a set ‚ù§Ô∏è', 'success');
        if(state.solvedGroups.length === 3){
          const remaining = state.tiles.map(t=>t.txt);
          const lastGroup = PUZZLE.categories.find(g => !state.solvedGroups.includes(g.name));
          addSolvedGroup(lastGroup.name, remaining);
          state.tiles = []; renderGrid();
          flashConn('You solved them all! üèÜ', 'success');
          progress.connections = true; unlockTab('wordle');
        }
      } else {
        state.lives--; livesEl.textContent = `Lives: ${state.lives}`;
        if(state.lives <= 0){ revealAll(); flashConn('Out of lives ‚Äî revealing answers‚Ä¶ üíî', 'fail'); }
        else { flashConn("Nope, those don't all match a category. Try again!"); }
      }
      renderGrid();
    }
    function addSolvedGroup(name, items){
      const box = document.createElement('div'); box.className = 'group';
      box.innerHTML = `<div class="badge">${name}</div><div style="margin-top:8px">${items.join(' ‚Ä¢ ')}</div>`;
      groupsEl.appendChild(box);
    }
    function revealAll(){ grid.innerHTML=''; groupsEl.innerHTML=''; PUZZLE.categories.forEach(g=>addSolvedGroup(g.name,g.items)); state.tiles=[]; state.selected.clear(); }
    function flashConn(msg, type){ toast.textContent = msg; toast.className = 'toast ' + (type||''); }
    function shuffle(a){ return a.map(v=>[Math.random(), v]).sort((x,y)=>x[0]-y[0]).map(p=>p[1]); }
    function groupBy(arr, fn){ return arr.reduce((m, x)=>{ const k = fn(x); (m[k]=m[k]||[]).push(x); return m; }, {}); }
    document.getElementById('shuffle').onclick = ()=>{ state.tiles = shuffle(state.tiles); renderGrid(); };
    document.getElementById('guess').onclick = guess;
    document.getElementById('deselect').onclick = ()=>{ state.selected.clear(); renderGrid(); };
    renderGrid();

    /************
     *  WORDLE  *
     ************/
    const WORDLE_ANSWER = 'KAYAK'; // <-- change me
    const N = 5, TRIES = 6;
    const board = document.getElementById('board');
    const kb = document.getElementById('keyboard');
    const msg = document.getElementById('wordle-msg');
    let row = 0, col = 0; let gridW = Array.from({length: TRIES}, ()=>Array(N).fill(''));

    function buildBoard(){
      board.innerHTML='';
      for(let r=0;r<TRIES;r++){
        const rowEl = document.createElement('div'); rowEl.className='row5';
        for(let c=0;c<N;c++){
          const cell = document.createElement('div'); cell.className='cell'; cell.id=`wcell-${r}-${c}`; rowEl.appendChild(cell);
        }
        board.appendChild(rowEl);
      }
    }
    function buildKeys(){
      kb.innerHTML='';
      const layout = [
        [...'qwertyuiop'],
        [...'asdfghjkl'],
        ['enter', ...'zxcvbnm', '‚å´']
      ];
      layout.flat().forEach(k =>{
        const b = document.createElement('button'); b.className = 'key' + ((k==='enter'||k==='‚å´')?' wide':'');
        b.textContent = k; b.onclick = ()=>handleKey(k);
        kb.appendChild(b);
      })
    }
    function renderWordle(){
      for(let r=0;r<TRIES;r++){
        for(let c=0;c<N;c++){
          const el = document.getElementById(`wcell-${r}-${c}`);
          el.textContent = gridW[r][c];
          el.classList.toggle('filled', !!gridW[r][c]);
        }
      }
    }
    function handleKey(k){
      if(row>=TRIES) return;
      if(k==='‚å´'){ if(col>0){ col--; gridW[row][col]=''; renderWordle(); } return; }
      if(k==='enter'){
        if(col<N){ flashW('Need 5 letters'); return; }
        submitRow(); return;
      }
      if(/^[a-z]$/i.test(k) && col < N){ gridW[row][col]=k.toUpperCase(); col++; renderWordle(); }
    }
    function submitRow(){
      const guess = gridW[row].join('');
      const answer = WORDLE_ANSWER.toUpperCase();
      const counts = {}; for(const ch of answer){ counts[ch]=(counts[ch]||0)+1; }
      let marks = Array(N).fill('miss');
      for(let i=0;i<N;i++) if(guess[i]===answer[i]){ marks[i]='correct'; counts[guess[i]]--; }
      for(let i=0;i<N;i++) if(marks[i]==='miss' && counts[guess[i]]>0){ marks[i]='present'; counts[guess[i]]--; }
      for(let i=0;i<N;i++){ const el = document.getElementById(`wcell-${row}-${i}`); el.classList.add(marks[i]); }
      if(guess===answer){ msg.textContent = 'You got it! üíò'; row=TRIES; progress.wordle=true; unlockTab('crossword'); return; }
      row++; col=0; if(row>=TRIES){ msg.textContent = `Answer was ${answer} ‚Äî still proud of you.`; }
    }
    function flashW(t){ msg.textContent = t; setTimeout(()=>{ if(row<TRIES) msg.textContent=''; }, 1200); }
    buildBoard(); buildKeys(); renderWordle();
    window.addEventListener('keydown', (e)=>{ const k=e.key.toLowerCase(); if(k==='backspace') handleKey('‚å´'); else if(k==='enter') handleKey('enter'); else if(/^[a-z]$/.test(k)) handleKey(k); });

    /****************
     *  MINI XWORD  *
     ****************/
    // Grid is 6x6. '#' = block. All other cells are active and validated against answers.
    // Across answers: LOVE (r3,c1) and KISS (r5,c1)
    // Down answers: HUG (c0,r0..2) and DATE (c4,r0..3), with DATE crossing LOVE at the final E.
    const XW = {
      // Upgraded 6x6 grid using our words; tight and fast.
      rows: 6, cols: 6,
      cells: Array.from({length:6}, ()=>Array(6).fill('#')),
      across: [
        { id:'A1', num:1, row:3, col:1, ans:'LOVE', clue:'Opposite of hate' },
        { id:'A2', num:2, row:5, col:1, ans:'KISS', clue:'Affectionate peck' },
      ],
      down: [
        { id:'D1', num:1, row:0, col:0, ans:'HUG', clue:'Squeezy embrace' },
        { id:'D2', num:2, row:0, col:4, ans:'DATE', clue:'Romantic night out' },
      ]
    };
    // Stamp expected letters into grid
    XW.across.forEach(({row,col,ans})=>{ for(let i=0;i<ans.length;i++){ XW.cells[row][col+i] = (ans[i]); } });
    XW.down.forEach(({row,col,ans})=>{ for(let i=0;i<ans.length;i++){ const r=row+i; const ch=ans[i]; if(XW.cells[r][col]==='#' || XW.cells[r][col]===ch){ XW.cells[r][col]=ch; } } });

    // Intense features
    let xwTimer = 300; // 5 minutes
    let xwTicker = null;
    let xwMistakes = 0;
    let xwReveals = 3;
    let xwDir = 'across'; // or 'down'
    let xwFocus = { row: XW.across[0].row, col: XW.across[0].col };

    function fmtTime(s){ const m=Math.floor(s/60).toString().padStart(2,'0'); const ss=(s%60).toString().padStart(2,'0'); return `${m}:${ss}`; }

    function buildMini(){
      const root = document.getElementById('xw-root'); root.innerHTML='';
      const wrap = document.createElement('div'); wrap.className='xw-wrap';
      for(let r=0;r<XW.rows;r++){
        for(let c=0;c<XW.cols;c++){
          const exp = XW.cells[r][c];
          const cell = document.createElement('input');
          cell.maxLength=1; cell.className='xw-cell';
          if(exp==='#'){ cell.classList.add('block'); cell.disabled=true; cell.value=''; }
          else { cell.dataset.r=r; cell.dataset.c=c; cell.addEventListener('input', onXwInput); cell.addEventListener('focus', ()=>setFocus(r,c)); cell.addEventListener('keydown', onXwKey); }
          wrap.appendChild(cell);
        }
      }
      root.appendChild(wrap);
      const clues = document.createElement('div'); clues.className='xw-clues';
      clues.innerHTML = `
        <div class="note"><strong>Across</strong><br>
          ${XW.across.map(c=>`${c.num}. ${c.clue} (${c.ans.length})`).join('<br>')}
        </div>
        <div class="note"><strong>Down</strong><br>
          ${XW.down.map(c=>`${c.num}. ${c.clue} (${c.ans.length})`).join('<br>')}
        </div>`;
      root.appendChild(clues);
      const note = document.createElement('div'); note.id='mini-note'; note.className='note'; root.appendChild(note);

      // HUD
      document.getElementById('xw-timer').textContent = fmtTime(xwTimer);
      document.getElementById('xw-mistakes').textContent = xwMistakes;
      document.getElementById('xw-reveal').textContent = `Reveal Letter (${xwReveals})`;

      clearInterval(xwTicker); xwTicker = setInterval(()=>{
        if(xwTimer<=0){ clearInterval(xwTicker); lockMini('Time\'s up! üòµ Reveal or Reset to try again.'); return; }
        xwTimer--; document.getElementById('xw-timer').textContent = fmtTime(xwTimer);
      }, 1000);
    }

    function onXwInput(e){
      e.target.value = e.target.value.toUpperCase();
      const r = +e.target.dataset.r, c = +e.target.dataset.c; const exp = XW.cells[r][c];
      if(e.target.value && e.target.value !== exp){ xwMistakes++; document.getElementById('xw-mistakes').textContent = xwMistakes; flashCell(e.target); }
      advance(r,c);
      checkMini();
    }
    function onXwKey(e){
      const r = +e.target.dataset.r, c = +e.target.dataset.c;
      if(e.key==='Backspace' && !e.target.value){ movePrev(r,c); e.preventDefault(); return; }
      if(['ArrowRight','ArrowLeft','ArrowUp','ArrowDown'].includes(e.key)){
        e.preventDefault();
        if(e.key==='ArrowRight') moveTo(r, c+1);
        if(e.key==='ArrowLeft') moveTo(r, c-1);
        if(e.key==='ArrowUp') moveTo(r-1, c);
        if(e.key==='ArrowDown') moveTo(r+1, c);
      }
      if(e.key==='Tab'){ e.preventDefault(); toggleDir(); }
    }

    function setFocus(r,c){ xwFocus={row:r,col:c}; highlightWord(r,c); }
    function toggleDir(){ xwDir = (xwDir==='across')?'down':'across'; highlightWord(xwFocus.row, xwFocus.col); }

    function moveTo(r,c){
      while(r>=0 && r<XW.rows && c>=0 && c<XW.cols){
        const el = document.querySelector(`.xw-cell[data-r="${r}"][data-c="${c}"]`);
        if(el){ el.focus(); return; }
        if(xwDir==='across'){ c += (c < xwFocus.col ? -1 : 1); } else { r += (r < xwFocus.row ? -1 : 1); }
      }
    }
    function movePrev(r,c){ if(xwDir==='across') moveTo(r, c-1); else moveTo(r-1, c); }
    function advance(r,c){ if(xwDir==='across') moveTo(r, c+1); else moveTo(r+1, c); }

    function highlightWord(r,c){
      document.querySelectorAll('.xw-cell').forEach(el=>el.style.outline='none');
      // Expand in both directions until block
      let cells=[];
      if(xwDir==='across'){
        let cc=c; while(cc>=0 && XW.cells[r][cc]!=='#') cc--; for(let i=cc+1;i<XW.cols && XW.cells[r][i]!=='#';i++){ const el=qCell(r,i); if(el) cells.push(el); }
      } else {
        let rr=r; while(rr>=0 && XW.cells[rr][c]!=='#') rr--; for(let i=rr+1;i<XW.rows && XW.cells[i][c]!=='#';i++){ const el=qCell(i,c); if(el) cells.push(el); }
      }
      cells.forEach(el=> el.style.outline='2px solid var(--accent)');
    }
    function qCell(r,c){ return document.querySelector(`.xw-cell[data-r="${r}"][data-c="${c}"]`); }

    function checkMini(){
      let allGood = true;
      for(let r=0;r<XW.rows;r++){
        for(let c=0;c<XW.cols;c++){
          const exp = XW.cells[r][c]; if(exp==='#') continue;
          const el = qCell(r,c);
          if(!el || (el.value.toUpperCase()||'') !== exp) allGood=false;
        }
      }
      const note = document.getElementById('mini-note');
      note.textContent = allGood? 'Solved! üß©' : '';
      if(allGood && !progress.crossword){ progress.crossword=true; clearInterval(xwTicker); showFinal(); }
    }

    function flashCell(el){ el.style.animation='shake .25s'; el.addEventListener('animationend', ()=>{ el.style.animation=''; }, {once:true}); }
    function lockMini(text){ document.getElementById('mini-note').textContent = text; document.querySelectorAll('.xw-cell:not(.block)').forEach(el=>el.disabled=true); }

    // Controls
    document.getElementById('xw-check').addEventListener('click', ()=>{
      let wrong=0; document.querySelectorAll('.xw-cell:not(.block)').forEach(el=>{ const r=+el.dataset.r, c=+el.dataset.c; if((el.value.toUpperCase()||'')!==XW.cells[r][c]){ wrong++; flashCell(el); }});
      if(wrong===0) flashToast('Looks perfect ‚ú®'); else flashToast(`${wrong} need${wrong>1?'':'s'} love`);
    });
    document.getElementById('xw-reveal').addEventListener('click', ()=>{
      if(xwReveals<=0) { flashToast('No reveals left!'); return; }
      const el = document.activeElement; if(!el || !el.classList.contains('xw-cell') || el.classList.contains('block')){ flashToast('Click a square first'); return; }
      const r=+el.dataset.r, c=+el.dataset.c; el.value = XW.cells[r][c]; xwReveals--; document.getElementById('xw-reveal').textContent = `Reveal Letter (${xwReveals})`; checkMini();
    });
    document.getElementById('xw-reset').addEventListener('click', ()=>{ clearInterval(xwTicker); xwTimer=300; xwMistakes=0; xwReveals=3; buildMini(); });

    function buildAndResetMini(){ buildMini(); }
    buildAndResetMini();

    function q(sel){ return document.querySelector(sel); }

    /*********
     *  TABS *
     *********/
    document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', ()=>{
      if(t.classList.contains('locked')){ flashToast('Finish the current game to unlock this one üîí'); return; }
      document.querySelectorAll('.tab').forEach(z=>z.classList.remove('active'));
      document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
      t.classList.add('active'); document.getElementById(t.dataset.view).classList.add('active');
    }));

    /*****************
     * FINAL MESSAGE *
     *****************/
    function showFinal(){
      document.getElementById('final-text').textContent = FINAL_MESSAGE;
      document.getElementById('final-modal').classList.remove('hidden');
    }
    document.getElementById('final-close').addEventListener('click', ()=>{
      document.getElementById('final-modal').classList.add('hidden');
    });
  </script>
</body>
</html>
